<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELMAR – Rejestr szkoleń personelu</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter','sans-serif'], display: ['Space Grotesk','sans-serif'] }, colors: { 'elmar-blue': '#1d4ed8' } } } };
    </script>
    <style>
        body { background:#0b1121; color:#e2e8f0; min-height:100vh; }
        .glass { background:rgba(15,23,42,0.65); border:1px solid rgba(148,163,184,0.2); backdrop-filter:blur(10px); box-shadow:0 20px 60px rgba(0,0,0,0.35); }
        input, textarea { color-scheme: dark; }
        .neon-fish { animation: float 3s ease-in-out infinite alternate; text-shadow: 0 0 6px rgba(56,189,248,0.9), 0 0 12px rgba(94,234,212,0.6); }
        @keyframes float { from { transform: translateY(0); } to { transform: translateY(-6px); } }
        .glow { background: linear-gradient(135deg, #3b82f6, #7c3aed); }
    </style>
</head>
<body class="p-5 md:p-8">
    <header class="max-w-7xl mx-auto flex flex-col lg:flex-row justify-between items-start gap-4 mb-8">
        <div class="flex items-center gap-3">
            <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-white font-display text-2xl">E</div>
            <div>
                <div class="flex items-center gap-2">
                    <h1 class="text-2xl font-display font-semibold text-white">ELMAR <span class="text-blue-300">Rejestr szkoleń</span></h1>
                    <i class="fa fa-fish text-cyan-300 text-lg neon-fish"></i>
                </div>
                <p class="text-slate-400 text-sm">Program sanitarny HACCP – szkolenia personelu</p>
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
            <button id="btn-add" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-3 rounded-xl font-medium shadow-lg flex items-center gap-2" onclick="openModal()"><i class="fa fa-plus"></i> Dodaj pracownika</button>
            <button class="glass px-4 py-3 rounded-xl text-slate-200 flex items-center gap-2" onclick="exportCSV()"><i class="fa fa-file-csv"></i> Eksport CSV</button>
            <button class="glass px-4 py-3 rounded-xl text-slate-200 flex items-center gap-2" onclick="exportExcel()"><i class="fa fa-file-excel"></i> Eksport Excel</button>
            <label class="glass px-4 py-3 rounded-xl text-slate-200 flex items-center gap-2 cursor-pointer">
                <i class="fa fa-file-import"></i> Import pracowników z pliku
                <input type="file" id="importFile" class="hidden" accept=".csv,.xlsx,.xls" onchange="importData(event)">
            </label>
            <a href="https://inovit.com.pl/szkolenie" target="_blank" class="glass px-4 py-3 rounded-xl text-slate-200 flex items-center gap-2">
                <i class="fa fa-graduation-cap"></i> Szkolenie wstępne online
            </a>
        </div>
    </header>

    <main class="max-w-7xl mx-auto space-y-6">
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="glass p-5 rounded-2xl">
                <p class="text-slate-400 text-xs uppercase tracking-wide">Pracownicy ogółem</p>
                <p id="statTotal" class="text-3xl font-bold">0</p>
            </div>
            <div class="glass p-5 rounded-2xl">
                <p class="text-slate-400 text-xs uppercase tracking-wide">Wygasa ≤ 30 dni (HACCP/BHP)</p>
                <p id="statWarning" class="text-3xl font-bold text-amber-300">0</p>
            </div>
            <div id="expiredCard" class="glass p-5 rounded-2xl relative overflow-visible cursor-pointer">
                <p class="text-slate-400 text-xs uppercase tracking-wide">Po terminie</p>
                <p id="statExpired" class="text-3xl font-bold text-rose-300">0</p>
                <div id="expiredTooltip" class="hidden absolute z-50 bottom-full mb-2 left-0 right-0 glass p-3 rounded-xl text-sm text-slate-200 shadow-2xl">
                    <p class="text-xs uppercase text-slate-400 mb-2">Filtrowanie opóźnień</p>
                    <div class="flex gap-2">
                        <button class="bg-rose-600/40 text-white px-3 py-2 rounded-lg text-xs" onclick="applyExpiredFilter(true)">Pokaż tylko po terminie</button>
                        <button class="glass px-3 py-2 rounded-lg text-xs text-slate-200" onclick="applyExpiredFilter(false)">Wróć do rejestru</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="glass rounded-2xl overflow-hidden">
            <div class="p-4 border-b border-slate-700 flex flex-col md:flex-row gap-3 md:items-center">
            <div class="relative w-full md:w-96">
                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                <input id="search" oninput="renderTable()" class="w-full bg-slate-900 border border-slate-700 rounded-lg pl-10 pr-3 py-2 text-sm" placeholder="Szukaj po imieniu lub nazwisku">
            </div>
            <div class="flex flex-wrap gap-2">
                <button class="btn-gradient glow px-4 py-2 rounded-lg text-white text-sm shadow-lg shadow-blue-500/40" onclick="openBulkModal()">Szkolenie okresowe</button>
                <button class="glass px-3 py-2 rounded-lg text-sm text-slate-200" onclick="deleteSelected()">Usuń zaznaczonych</button>
                <button class="glass px-3 py-2 rounded-lg text-sm text-slate-200" onclick="undoLast()">Cofnij zmiany</button>
                <button class="glass px-3 py-2 rounded-lg text-sm text-slate-200" onclick="applyExpiredFilter(true)">Pokaż tylko po terminie</button>
                <button class="glass px-3 py-2 rounded-lg text-sm text-slate-200" onclick="applyExpiredFilter(false)">Wróć do rejestru</button>
            </div>
                <div class="text-sm text-slate-400">Dane zapisywane lokalnie (localStorage).</div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-900/70 text-slate-400 uppercase text-xs">
                        <tr>
                            <th class="p-3 text-left"><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
                            <th class="p-3 text-left">Lp.</th>
                            <th class="p-3 text-left">Imię i nazwisko</th>
                            <th class="p-3 text-left">Data zatr.</th>
                            <th class="p-3 text-left">Wstępne higiena</th>
                            <th class="p-3 text-left">Wstępne stanow.</th>
                            <th class="p-3 text-left">Wstępne BHP</th>
                            <th class="p-3 text-left">Okresowe HACCP</th>
                            <th class="p-3 text-left">Okresowe BHP</th>
                            <th class="p-3 text-left">Notatki</th>
                            <th class="p-3 text-right">Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-800 text-slate-100"></tbody>
                </table>
                <div id="empty" class="hidden p-8 text-center text-slate-400">Brak wpisów. Dodaj pierwszego pracownika.</div>
            </div>
        </section>
    </main>

    <footer class="max-w-7xl mx-auto mt-10 mb-6 glass rounded-2xl p-6 text-sm text-slate-300 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="flex items-center gap-3">
            <img src="logo.png" alt="ELMAR logo" class="h-12 w-auto rounded-md shadow-lg">
            <div>
                <div class="font-semibold text-white">P.H.U. ELMAR Lesiuk spółka jawna</div>
                <div>ul. Droga Wojskowa 39, 21-500 Biała Podlaska</div>
            </div>
        </div>
        <div class="text-slate-400 text-xs md:text-sm">
            created by: Krzysztof Klebaniuk | INOVIT · www.inovit.com.pl · kontakt@inovit.com.pl · +48 575 757 638
        </div>
    </footer>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 hidden z-50">
        <div class="absolute inset-0 bg-black/70" onclick="closeModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-3xl px-4">
            <div class="glass rounded-2xl p-6 relative">
                <button class="absolute right-4 top-4 text-slate-400" onclick="closeModal()"><i class="fa fa-times"></i></button>
                <h2 id="modalTitle" class="text-xl font-display mb-4">Nowy pracownik</h2>
                <form id="form" class="space-y-4" onsubmit="submitForm(event)">
                    <input type="hidden" id="editId">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-slate-400">Imię</label>
                            <input id="firstName" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3" required>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">Nazwisko</label>
                            <input id="lastName" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3" required>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="text-xs text-slate-400">Data zatrudnienia</label>
                            <input type="date" id="hireDate" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3" required>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">Wstępne higiena</label>
                            <input type="date" id="initialHygiene" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3" required>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">Wstępne stanowiskowe</label>
                            <input type="date" id="initialPosition" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3" required>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="text-xs text-slate-400">Wstępne BHP</label>
                            <input type="date" id="initialBhp" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3" required>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">Okresowe HACCP (+1 rok)</label>
                            <input type="date" id="periodicHaccp" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3" required>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">Okresowe BHP (+3 lata)</label>
                            <input type="date" id="periodicBhp" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3" required>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">Notatki</label>
                        <textarea id="notes" rows="2" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3"></textarea>
                    </div>
                    <div class="flex flex-wrap gap-3 justify-end">
                        <button type="button" class="px-4 py-3 rounded-lg bg-slate-700" onclick="closeModal()">Anuluj</button>
                        <button type="submit" class="px-5 py-3 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 text-white">Zapisz</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: szkolenie okresowe (pojedyncze) -->
    <div id="trainingModal" class="fixed inset-0 hidden z-50">
        <div class="absolute inset-0 bg-black/70" onclick="closeTrainingModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md px-4">
            <div class="glass rounded-2xl p-6 relative">
                <button class="absolute right-4 top-4 text-slate-400" onclick="closeTrainingModal()"><i class="fa fa-times"></i></button>
                <h3 class="text-xl font-display mb-4">Szkolenie okresowe</h3>
                <p id="trainingTarget" class="text-slate-400 text-sm mb-3"></p>
                <label class="text-xs text-slate-400 block mb-2">Data szkolenia</label>
                <input type="date" id="trainingDate" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 mb-4">
                <div class="flex gap-3 justify-end">
                    <button class="bg-slate-700 px-4 py-2 rounded-lg" onclick="closeTrainingModal()">Anuluj</button>
                    <button class="btn-gradient px-4 py-2 rounded-lg text-white" onclick="confirmTraining()">Wykonaj szkolenie</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: szkolenie okresowe zbiorcze -->
    <div id="bulkModal" class="fixed inset-0 hidden z-50">
        <div class="absolute inset-0 bg-black/70" onclick="closeBulkModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl px-4">
            <div class="glass rounded-2xl p-6 relative">
                <button class="absolute right-4 top-4 text-slate-400" onclick="closeBulkModal()"><i class="fa fa-times"></i></button>
                <h3 class="text-xl font-display mb-4">Szkolenie okresowe zbiorcze</h3>
                <div class="flex gap-4 mb-4">
                    <label class="flex items-center gap-2 text-slate-200 text-sm">
                        <input type="radio" name="bulkType" value="haccp" checked> HACCP (+1 rok)
                    </label>
                    <label class="flex items-center gap-2 text-slate-200 text-sm">
                        <input type="radio" name="bulkType" value="bhp"> BHP (+3 lata)
                    </label>
                </div>
                <div class="mb-3">
                    <label class="text-xs text-slate-400 block mb-2">Data szkolenia</label>
                    <input type="date" id="bulkDate" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3">
                </div>
                <div class="max-h-64 overflow-auto border border-slate-700 rounded-xl p-3 mb-4">
                    <table class="w-full text-sm">
                        <thead class="text-slate-400 uppercase text-xs">
                            <tr><th class="text-left py-2"><input type="checkbox" id="bulkSelectAll" onclick="bulkToggleAll(this)"></th><th class="text-left py-2">Pracownik</th><th class="text-left py-2">Data zatr.</th></tr>
                        </thead>
                        <tbody id="bulkList" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
                <div class="flex gap-3 justify-end">
                    <button class="bg-slate-700 px-4 py-2 rounded-lg" onclick="closeBulkModal()">Anuluj</button>
                    <button class="btn-gradient px-4 py-2 rounded-lg text-white" onclick="confirmBulkTraining()">Wykonaj szkolenie</button>
                </div>
            </div>
        </div>
    </div>
<script>
const STORAGE_KEY = 'elmar_rejestr_v3';
let employees = [];
let history = [];
let selectedIds = new Set();
let expiredFilter = false;
let tooltipOpen = false;
let trainingContext = { id: null, type: 'haccp' };
let bulkChecked = new Set();

const qs = id => document.getElementById(id);

function loadData(){
    try{
        const stored = localStorage.getItem(STORAGE_KEY);
        if(stored){ employees = JSON.parse(stored) || []; }
    } catch(e){ console.error('Błąd odczytu localStorage', e); employees = []; }
    history = [];
    selectedIds.clear();
    renderTable();
    updateStats();
}

function saveData(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(employees));
    renderTable();
    updateStats();
}

function pushHistory(){
    history.push(JSON.parse(JSON.stringify(employees)));
    if(history.length > 30) history.shift();
}

function openModal(emp){
    qs('modal').classList.remove('hidden');
    const today = new Date();
    const isoToday = today.toISOString().slice(0,10);
    if(!emp){
        qs('form').reset();
        qs('editId').value = '';
        qs('hireDate').value = isoToday;
        autofillDates();
        qs('modalTitle').innerText = 'Nowy pracownik';
    } else {
        qs('editId').value = emp.id;
        qs('firstName').value = emp.firstName;
        qs('lastName').value = emp.lastName;
        qs('hireDate').value = emp.hireDate;
        qs('initialHygiene').value = emp.initialHygiene;
        qs('initialPosition').value = emp.initialPosition;
        qs('initialBhp').value = emp.initialBhp;
        qs('periodicHaccp').value = emp.periodicHaccp;
        qs('periodicBhp').value = emp.periodicBhp;
        qs('notes').value = emp.notes || '';
        qs('modalTitle').innerText = 'Edytuj pracownika';
    }
}

function closeModal(){ qs('modal').classList.add('hidden'); }

function addYears(dateStr, years){
    if(!dateStr) return '';
    const d = new Date(dateStr);
    if(isNaN(d)) return '';
    d.setFullYear(d.getFullYear() + years);
    return d.toISOString().slice(0,10);
}

function normalizeDate(value){
    if(!value && value !== 0) return '';
    // Excel serial
    if(typeof value === 'number'){
        const parsed = XLSX.SSF.parse_date_code(value);
        if(!parsed) return '';
        return `${parsed.y}-${String(parsed.m).padStart(2,'0')}-${String(parsed.d).padStart(2,'0')}`;
    }
    let v = String(value).trim();
    if(!v) return '';
    // dd.mm.yyyy or dd/mm/yyyy
    const dot = /^(\d{1,2})[./-](\d{1,2})[./-](\d{4})$/;
    const m = v.match(dot);
    if(m){
        return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
    }
    // try ISO or locale
    const d = new Date(v);
    if(!isNaN(d)) return d.toISOString().slice(0,10);
    return '';
}

function autofillDates(){
    const hire = qs('hireDate').value;
    if(!hire) return;
    qs('initialHygiene').value = hire;
    qs('initialPosition').value = hire;
    qs('initialBhp').value = hire;
    qs('periodicHaccp').value = addYears(hire,1);
    qs('periodicBhp').value = addYears(hire,3);
}

qs('hireDate').addEventListener('change', autofillDates);

function submitForm(e){
    e.preventDefault();
    pushHistory();
    const data = {
        id: qs('editId').value || crypto.randomUUID(),
        firstName: qs('firstName').value.trim(),
        lastName: qs('lastName').value.trim(),
        hireDate: qs('hireDate').value,
        initialHygiene: qs('initialHygiene').value,
        initialPosition: qs('initialPosition').value,
        initialBhp: qs('initialBhp').value,
        periodicHaccp: qs('periodicHaccp').value,
        periodicBhp: qs('periodicBhp').value,
        notes: qs('notes').value.trim()
    };
    const idx = employees.findIndex(e => e.id === data.id);
    if(idx >= 0) employees[idx] = data; else employees.push(data);
    saveData();
    closeModal();
}

function deleteRow(id){
    if(!confirm('Usunąć wpis?')) return;
    pushHistory();
    employees = employees.filter(e => e.id !== id);
    selectedIds.delete(id);
    saveData();
}

function formatDate(d){ return d ? new Date(d).toLocaleDateString('pl-PL') : '-'; }

function statusFor(emp){
    const today = new Date(); today.setHours(0,0,0,0);
    const nearest = [emp.periodicHaccp, emp.periodicBhp].filter(Boolean).map(d => new Date(d)).sort((a,b)=>a-b)[0];
    if(!nearest) return {cls:'', label:'-'};
    const diff = Math.ceil((nearest - today)/(1000*60*60*24));
    if(diff < 0) return {cls:'text-rose-300', label:'Po terminie'};
    if(diff <= 30) return {cls:'text-amber-300', label:`${diff} dni do końca`};
    return {cls:'text-emerald-300', label:'Aktualne'};
}

function renderTable(){
    const tbody = qs('tableBody');
    const search = (qs('search').value || '').toLowerCase();
    tbody.innerHTML = '';
    let filtered = employees.filter(e => (`${e.firstName} ${e.lastName}`).toLowerCase().includes(search));
    if(expiredFilter){
        filtered = filtered.filter(isExpired);
    }
    qs('empty').classList.toggle('hidden', filtered.length !== 0);
    filtered.sort((a,b)=>{
        const da = a.hireDate ? new Date(a.hireDate).getTime() : Infinity;
        const db = b.hireDate ? new Date(b.hireDate).getTime() : Infinity;
        if(da === db) return a.lastName.localeCompare(b.lastName, 'pl');
        return da - db;
    });
    filtered.forEach((emp, idx)=>{
        const status = statusFor(emp);
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/5';
        const checkedAttr = selectedIds.has(emp.id) ? 'checked' : '';
        tr.innerHTML = `
            <td class="p-3"><input type="checkbox" class="row-check" data-id="${emp.id}" ${checkedAttr} onchange="updateSelection(this)"></td>
            <td class="p-3 text-slate-500">${idx+1}</td>
            <td class="p-3 font-semibold">${emp.firstName} ${emp.lastName}<div class="text-xs ${status.cls}">${status.label}</div></td>
            <td class="p-3">${formatDate(emp.hireDate)}</td>
            <td class="p-3">${colorizeDate(emp.initialHygiene)}</td>
            <td class="p-3">${colorizeDate(emp.initialPosition)}</td>
            <td class="p-3">${colorizeDate(emp.initialBhp)}</td>
            <td class="p-3">${trainingCell(emp,'haccp')}</td>
            <td class="p-3">${trainingCell(emp,'bhp')}</td>
            <td class="p-3 max-w-xs whitespace-pre-wrap">${emp.notes || ''}</td>
            <td class="p-3 text-right space-x-2">
                <button class="text-emerald-300 hover:text-white text-xs px-2 py-1 bg-slate-700 rounded-lg" onclick="openTrainingModal('${emp.id}','haccp')">HACCP</button>
                <button class="text-amber-300 hover:text-white text-xs px-2 py-1 bg-slate-700 rounded-lg" onclick="openTrainingModal('${emp.id}','bhp')">BHP</button>
                <button class="text-blue-300 hover:text-white" onclick="openModalById('${emp.id}')"><i class="fa fa-pen"></i></button>
                <button class="text-rose-300 hover:text-white" onclick="deleteRow('${emp.id}')"><i class="fa fa-trash"></i></button>
            </td>`;
        tbody.appendChild(tr);
    });
    updateSelectAllCheckbox();
}

function updateStats(){
    const today = new Date(); today.setHours(0,0,0,0);
    let warning=0, expired=0;
    employees.forEach(emp=>{
        [emp.periodicHaccp, emp.periodicBhp].forEach(d=>{
            if(!d) return;
            const diff = Math.ceil((new Date(d) - today)/(1000*60*60*24));
            if(diff < 0) { expired++; }
            else if(diff <=30) warning++;
        });
    });
    qs('statTotal').innerText = employees.length;
    qs('statWarning').innerText = warning;
    qs('statExpired').innerText = expired;
}

function openModalById(id){
    const emp = employees.find(e=>e.id===id);
    openModal(emp);
}

// --- Szkolenie okresowe pojedyncze ---
function openTrainingModal(id, type){
    trainingContext = { id, type };
    const emp = employees.find(e=>e.id===id);
    if(!emp) return;
    qs('trainingTarget').innerText = `${emp.firstName} ${emp.lastName} — ${type.toUpperCase()}`;
    qs('trainingDate').value = new Date().toISOString().slice(0,10);
    qs('trainingModal').classList.remove('hidden');
}

function closeTrainingModal(){
    qs('trainingModal').classList.add('hidden');
}

function confirmTraining(){
    const date = qs('trainingDate').value;
    if(!date){ alert('Podaj datę szkolenia'); return; }
    const emp = employees.find(e=>e.id===trainingContext.id);
    if(!emp) return;
    if(!confirm('Czy chcesz zaktualizować szkolenie okresowe?')) return;
    pushHistory();
    const next = trainingContext.type === 'bhp' ? addYears(date,3) : addYears(date,1);
    if(trainingContext.type === 'bhp') {
        emp.periodicBhp = next;
        emp.periodicBhpLast = date;
    } else {
        emp.periodicHaccp = next;
        emp.periodicHaccpLast = date;
    }
    saveData();
    closeTrainingModal();
}

// --- Szkolenie okresowe zbiorcze ---
function openBulkModal(){
    bulkChecked = new Set();
    qs('bulkDate').value = new Date().toISOString().slice(0,10);
    renderBulkList();
    qs('bulkModal').classList.remove('hidden');
}
function closeBulkModal(){ qs('bulkModal').classList.add('hidden'); }

function renderBulkList(){
    const tbody = qs('bulkList');
    tbody.innerHTML = '';
    employees
      .slice()
      .sort((a,b)=>a.lastName.localeCompare(b.lastName,'pl'))
      .forEach(emp=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2"><input type="checkbox" data-id="${emp.id}" onchange="bulkToggle(this)"></td>
          <td class="py-2 text-slate-100">${emp.firstName} ${emp.lastName}</td>
          <td class="py-2 text-slate-400">${formatDate(emp.hireDate)}</td>
        `;
        tbody.appendChild(tr);
      });
    qs('bulkSelectAll').checked = false;
}

function bulkToggleAll(master){
    const checks = document.querySelectorAll('#bulkList input[type=checkbox]');
    checks.forEach(c=>{
        c.checked = master.checked;
        if(master.checked) bulkChecked.add(c.dataset.id); else bulkChecked.delete(c.dataset.id);
    });
}
function bulkToggle(el){
    if(el.checked) bulkChecked.add(el.dataset.id); else bulkChecked.delete(el.dataset.id);
    const checks = document.querySelectorAll('#bulkList input[type=checkbox]');
    const checked = Array.from(checks).filter(c=>c.checked).length;
    qs('bulkSelectAll').checked = checked === checks.length;
}

function confirmBulkTraining(){
    const date = qs('bulkDate').value;
    if(!date){ alert('Podaj datę szkolenia'); return; }
    if(bulkChecked.size === 0){ alert('Wybierz pracowników'); return; }
    const type = document.querySelector('input[name="bulkType"]:checked').value;
    if(!confirm(`Czy chcesz zaktualizować szkolenie okresowe ${type.toUpperCase()} dla wskazanych pracowników?`)) return;
    pushHistory();
    const nextFn = type === 'bhp' ? (d)=>addYears(d,3) : (d)=>addYears(d,1);
    employees = employees.map(emp=>{
        if(!bulkChecked.has(emp.id)) return emp;
        const next = nextFn(date);
        if(type==='bhp') return {...emp, periodicBhp: next, periodicBhpLast: date};
        return {...emp, periodicHaccp: next, periodicHaccpLast: date};
    });
    saveData();
    closeBulkModal();
}
function isExpired(emp){
    const today = new Date(); today.setHours(0,0,0,0);
    return [emp.periodicHaccp, emp.periodicBhp].some(d=>{
        if(!d) return false;
        const diff = Math.ceil((new Date(d) - today)/(1000*60*60*24));
        return diff < 0;
    });
}

// --- Eksport / Import ---
function exportExcel(){
    const worksheet = XLSX.utils.json_to_sheet(employees.map(e=>({
        Lp: '',
        Imie: e.firstName,
        Nazwisko: e.lastName,
        Data_zatrudnienia: e.hireDate,
        Wstepne_higiena: e.initialHygiene,
        Wstepne_stanowiskowe: e.initialPosition,
        Wstepne_BHP: e.initialBhp,
        Okresowe_HACCP: e.periodicHaccp,
        Okresowe_BHP: e.periodicBhp,
        Notatki: e.notes
    })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, worksheet, 'Rejestr');
    XLSX.writeFile(wb, `ELMAR_rejestr_${new Date().toISOString().slice(0,10)}.xlsx`);
}

function importData(evt){
    const file = evt.target.files[0];
    if(!file) return;
    const ext = file.name.split('.').pop().toLowerCase();
    const reader = new FileReader();
    reader.onload = e => {
        try{
            pushHistory();
            let imported = [];
            if(ext === 'csv'){
                imported = parseCSV(e.target.result);
            } else {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type:'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:''});
                imported = rows
                    .map((row, idx) => {
                        if(row.length === 0 || (idx === 0 && row.some(c=>String(c).toLowerCase().includes('imi')))) return null;
                        const firstName = row[0] || '';
                        const lastName = row[1] || '';
                        const hireDate = normalizeDate(row[4] || row[2] || '');
                        return normalizeEmployee({firstName,lastName,hireDate});
                    })
                    .filter(Boolean);
            }
            if(!Array.isArray(imported)) throw new Error('Błędny format');
            employees = [...employees, ...imported];
            selectedIds.clear();
            saveData();
        } catch(err){ alert('Nie udało się zaimportować pliku.'); console.error(err); }
        evt.target.value = '';
    };
    if(ext === 'csv') reader.readAsText(file, 'UTF-8'); else reader.readAsArrayBuffer(file);
}

document.addEventListener('DOMContentLoaded', loadData);
document.addEventListener('DOMContentLoaded', () => {
    const card = qs('expiredCard');
    if(card){
        card.addEventListener('click', (e)=>{
            e.stopPropagation();
            tooltipOpen = !tooltipOpen;
            qs('expiredTooltip').classList.toggle('hidden', !tooltipOpen);
        });
    }
    const tooltip = qs('expiredTooltip');
    if(tooltip){
        tooltip.addEventListener('click', e=>e.stopPropagation());
    }
    document.addEventListener('click', ()=>{
        if(!tooltipOpen) return;
        tooltipOpen = false;
        qs('expiredTooltip').classList.add('hidden');
    });
});

// --- Kolorowanie dat i badge'y statusu ---
function colorizeDate(dateStr, isPeriodic=false){
    if(!dateStr) return '-';
    if(!isPeriodic) return formatDate(dateStr);
    const status = dateStatus(dateStr);
    return `<span class="${status.cls}">${formatDate(dateStr)}</span>${status.badge}`;
}

function dateStatus(dateStr){
    const today = new Date(); today.setHours(0,0,0,0);
    const diff = Math.ceil((new Date(dateStr) - today)/(1000*60*60*24));
    if(diff < 0) return {cls:'text-rose-300', badge:' <span class="ml-1 text-rose-400 text-xs">(po terminie)</span>'};
    if(diff <= 30) return {cls:'text-amber-300', badge:` <span class="ml-1 text-amber-300 text-xs">(${diff} dni)</span>`};
    return {cls:'text-emerald-300', badge:''};
}

function normalizeEmployee(raw){
    const hire = normalizeDate(raw.hireDate || '');
    const base = {
        id: raw.id || crypto.randomUUID(),
        firstName: raw.firstName || '',
        lastName: raw.lastName || '',
        hireDate: hire,
        initialHygiene: raw.initialHygiene || hire,
        initialPosition: raw.initialPosition || hire,
        initialBhp: raw.initialBhp || hire,
        periodicHaccp: raw.periodicHaccp || addYears(hire || new Date().toISOString().slice(0,10), 1),
        periodicBhp: raw.periodicBhp || addYears(hire || new Date().toISOString().slice(0,10), 3),
        periodicHaccpLast: raw.periodicHaccpLast || '',
        periodicBhpLast: raw.periodicBhpLast || '',
        notes: raw.notes || ''
    };
    return base;
}

// --- Zaznaczanie i operacje grupowe ---
function toggleAll(master){
    const rows = document.querySelectorAll('.row-check');
    rows.forEach(cb => {
        cb.checked = master.checked;
        if(master.checked) selectedIds.add(cb.dataset.id); else selectedIds.delete(cb.dataset.id);
    });
}

function updateSelection(el){
    if(el.checked) selectedIds.add(el.dataset.id); else selectedIds.delete(el.dataset.id);
    updateSelectAllCheckbox();
}

function updateSelectAllCheckbox(){
    const master = qs('selectAll');
    if(!master) return;
    const rows = document.querySelectorAll('.row-check');
    if(rows.length === 0){ master.checked = false; master.indeterminate = false; return; }
    const checked = Array.from(rows).filter(cb => cb.checked).length;
    master.checked = checked === rows.length;
    master.indeterminate = checked > 0 && checked < rows.length;
}

function deleteSelected(){
    if(selectedIds.size === 0){ alert('Nie zaznaczono żadnych pracowników.'); return; }
    if(!confirm(`Usunąć ${selectedIds.size} zaznaczonych pracowników?`)) return;
    pushHistory();
    employees = employees.filter(e => !selectedIds.has(e.id));
    selectedIds.clear();
    saveData();
}

// --- Cofanie ---
function undoLast(){
    if(history.length === 0){ alert('Brak historii do cofnięcia.'); return; }
    employees = history.pop();
    selectedIds.clear();
    saveData();
}

// --- Filtrowanie po terminie ---
function applyExpiredFilter(state){
    expiredFilter = state;
    renderTable();
}

// --- Eksport / import CSV ---
function exportCSV(){
    const header = ['Imie','Nazwisko','Data_zatrudnienia','Wstepne_higiena','Wstepne_stanowiskowe','Wstepne_BHP','Okresowe_HACCP','Okresowe_BHP','Notatki'];
    const lines = employees.map(e=>[
        e.firstName, e.lastName, e.hireDate, e.initialHygiene, e.initialPosition, e.initialBhp, e.periodicHaccp, e.periodicBhp, (e.notes||'')
    ].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(';'));
    const csv = header.join(';') + '\\n' + lines.join('\\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `ELMAR_rejestr_${new Date().toISOString().slice(0,10)}.csv`; a.click();
    URL.revokeObjectURL(url);
}

function parseCSV(text){
    const rows = text.trim().split(/\r?\n/);
    if(rows.length === 0) return [];
    const delimiter = rows[0].includes(';') ? ';' : ',';
    const headers = rows[0].split(delimiter).map(h=>h.trim());
    const dataRows = rows.slice(1).filter(r=>r.trim().length>0);
    return dataRows.map(line=>{
        const cols = line.split(delimiter).map(c=>c.replace(/^\"|\"$/g,'').replace(/\"\"/g,'\"').trim());
        const get = name => {
            const idx = headers.findIndex(h=>h.toLowerCase()===name.toLowerCase());
            return idx>=0 ? cols[idx] : '';
        };
        const firstName = get('Imie') || get('Imię') || cols[0] || '';
        const lastName  = get('Nazwisko') || cols[1] || '';
        const hireDate  = normalizeDate(get('Data_zatrudnienia') || cols[2] || '');
        return normalizeEmployee({firstName,lastName,hireDate});
    });
}
</script>
</body>
</html>
